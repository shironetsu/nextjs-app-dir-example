# ã€ŒNext.js 13 app directory ã§è¨˜äº‹æŠ•ç¨¿ã‚µã‚¤ãƒˆã‚’ä½œã£ã¦ã¿ã‚ˆã†ã€ã‚’èª­ã‚€

[Next\.js 13 app directory ã§è¨˜äº‹æŠ•ç¨¿ã‚µã‚¤ãƒˆã‚’ä½œã£ã¦ã¿ã‚ˆã†](https://zenn.dev/azukiazusa/articles/next-js-app-dir-tutorial)


## èµ·å‹•

```
info  - VS Code settings.json has been created for Next.js' automatic app types, this file can be added to .gitignore if desired
```

## `app/page.tsx` ç·¨é›†

> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ãŸå¾Œ http://localhost:3000/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºãŒåˆ‡ã‚Šæ›¿ã‚ã£ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

`layout.tsx` ã‚’æ®‹ã—ãŸçŠ¶æ…‹ã ã¨ã‚¹ã‚¿ã‚¤ãƒ«ãŒé©ç”¨ã•ã‚Œã‚‹ã€‚

## `app/articles/[slug]/page.tsx` ä½œæˆ

`app/articles/[slug]/page.tsx` ã‚’ä½œã‚‹ã€‚

> å°†æ¥çš„ã« params ã®å‹ã¯ TypeScript plugin ã«ã‚ˆã‚Šè‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹äºˆå®šã§ã™ã€‚

æ°—ã«ãªã‚‹ğŸ‘€

## `app/layout.tsx` ç·¨é›†

> Next.js ã¯ `<html>` ã‚„ `<body>` ã‚¿ã‚°ã‚’è‡ªå‹•çš„ã«ç”Ÿæˆã—ãªã„ã®ã§ã€`app/layout.tsx` ãƒ•ã‚¡ã‚¤ãƒ«ã§å¿…ãšå®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¸ãƒ¼ã€‚


ã“ã“ã§æ€’ã‚‰ã‚Œã‚‹

```ts
export const metadata = {
           //^^^^^^^^ "metadata" is not a valid Next.js entry export value.
  title: "Create Next App",
  description: "Generated by create next app",
  themeColor: "#ffffff",
};
```

[Getting a TypeScript error: "metadata" is not a valid next\.js entry export value : r/nextjs](https://www.reddit.com/r/nextjs/comments/11xqy91/getting_a_typescript_error_metadata_is_not_a/)

æ°—ã«ãªã‚‹ãŒã®ã‚¨ãƒ©ãƒ¼ã§ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºã«å½±éŸ¿ã—ã¦ã„ãªã„ã®ã§ä¸€æ—¦æ”¾ç½®ã€‚
"Next.js entry export value"ã£ã¦TSã®ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ¤œçŸ¥ã§ãã‚‹ã®ï¼Ÿ

## Chakra UI å°å…¥

```
npm i @chakra-ui/react @emotion/react@^11 @emotion/styled@^11 framer-motion@^6
```

## app/lauout.tsx ã« ChakraProvider ã‚’è¿½åŠ 

```
./node_modules/@chakra-ui/accordion/dist/chunk-JDQBKIKM.mjs

You're importing a component that needs useState. It only works in a Client Component but none of its parents are marked with "use client", so they're Server Components by default.

    ,-[8:1]
  8 | import { useControllableState } from "@chakra-ui/react-use-controllable-state";
  9 | import { mergeRefs } from "@chakra-ui/react-use-merge-refs";
 10 | import { callAllHandlers, warn } from "@chakra-ui/shared-utils";
 11 | import { useCallback, useEffect, useId, useRef, useState } from "react";
    :                                                 ^^^^^^^^
 12 | function useAccordion(props) {
 13 |   const {
 14 |     onChange,
    `----

Maybe one of these should be marked as a client entry with "use client":
  node_modules\@chakra-ui\accordion\dist\chunk-JDQBKIKM.mjs
  node_modules\@chakra-ui\accordion\dist\index.mjs
  node_modules\@chakra-ui\react\dist\index.mjs
  app\layout.tsx
```

Server Component, `onClick`ã€€ã™ã‚‰ä½¿ãˆãªã„ã®ã‹ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã¿ãŸã„ã ã€‚

## app/Provider.tsx ä½œæˆ

`components` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã‹ã§ã¯ãªãã¦ `page.tsx` ã¨åŒéšå±¤ã«ç½®ã„ã¦ã—ã¾ã†ã€‚

## ãƒ“ãƒ«ãƒ‰

1å›ãƒ“ãƒ«ãƒ‰ã—ã¦ã¿ã‚‹ã€‚

```
Route (app)                                Size     First Load JS
â”Œ â—‹ /                                      0 B                0 B
â”” Î» /articles/[slug]                       139 B          66.6 kB
+ First Load JS shared by all              66.4 kB
  â”œ chunks/17-35779e5c4405374c.js          64.5 kB
â”” Î» /api/articles/[slug]/comments          0 B            81.1 kB
+ First Load JS shared by all              81.1 kB
  â”œ chunks/main-07078917cb8e3d57.js        79.2 kB
  â”œ chunks/pages/_app-5841ab2cb3aa228d.js  192 B
  â”” chunks/webpack-c58b595510065273.js     1.75 kB

Î»  (Server)  server-side renders at runtime (uses getInitialProps or getServerSideProps)
â—‹  (Static)  automatically rendered as static HTML (uses no initial props)
```

## fetch

> app/pages.tsx å†…ã§ http://localhost:3000/api/articles ã‹ã‚‰è¨˜äº‹ã®ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚

`page.tsx` ã£ã½ã„ã€‚

`Home` ã‚’ async é–¢æ•°ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰ã¨ã—ã¦å†å®šç¾©ã™ã‚‹ã€‚

> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ `fetch` ã‚’ä½¿ç”¨ã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸå¾Œã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ `fetch` ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `{ cache: "force-cache" }` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚`force-cache` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ `getStaticProp` ã¨è¿‘ã„åƒãã§ã™ã€‚

ã»ã¼æ°¸ç¶šï¼Ÿã€€å†æ¤œè¨¼ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ï¼Ÿ

TODO: Next.js ã® `fetch` ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¦‹ã‚‹

`fetch` ã¯å‹çš„ã«ã¯ Node æ¨™æº–ã®ã‚‚ã®ã¨åŒã˜ã€‚

## app/loading.tsx è¿½åŠ 

> ã“ã®æŒ™å‹•ã¯ Suspense ã«ãŠã‘ã‚‹ `fallback` ã¨åŒã˜ã§ã™ã€‚

`page.tsx` ã® `resolve` ãŒæ¸ˆã‚€ã¾ã§ã€ `layout.tsx` ã® `children` ã®éƒ¨åˆ†ä¸¸ã”ã¨ã“ã‚Œã«ãªã‚‹ã€‚

## app/error.tsx è¿½åŠ 

> ã¾ãŸ `error.tsx` ã¯å¿…ãš Client Component ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚

ã‚ã–ã¨ `"use client";` ã‚’æ¬ ãã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã«ä½•ã‚‚å‡ºãªã„ã€‚

```
Error: Functions cannot be passed directly to Client Components because they're not serializable.
  <... parallelRouterKey=... segmentPath=... error={function} errorStyles=... loading=... loadingStyles=... hasLoading=... template=... templateStyles=... notFound=... notFoundStyles=... childProp=... rootLayoutIncluded=...>
                                                   ^^^^^^^^^^
    at resolveModelToJSON (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1766:39)
    at Object.toJSON (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1132:40)
    at stringify (<anonymous>)
    at processModelChunk (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:172:36)
    at retryTask (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1879:50)
    at performWork (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1917:33)
    at eval (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1308:40)    
    at scheduleWork (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:52:25)
    at pingTask (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1307:29)
    at ping (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1320:40)    
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Error: Functions cannot be passed directly to Client Components because they're not serializable.
  <... parallelRouterKey=... segmentPath=... error={function} errorStyles=... loading=... loadingStyles=... hasLoading=... template=... templateStyles=... notFound=... notFoundStyles=... childProp=... rootLayoutIncluded=...>
                                                   ^^^^^^^^^^
    at resolveModelToJSON (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1766:39)
    at Object.toJSON (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1132:40)
    at stringify (<anonymous>)
    at processModelChunk (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:172:36)
    at retryTask (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1879:50)
    at performWork (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1917:33)
    at eval (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1308:40)    
    at scheduleWork (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:52:25)
    at pingTask (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1307:29)
    at ping (webpack-internal:///(sc_server)/./node_modules/next/dist/compiled/react-server-dom-webpack/server.browser.js:1320:40)    
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5) {
  digest: '4084611050'
}
```

## ArticleList ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

`app/components/ArticleCard.tsx` ã¨ã‚ã‚‹ãŒãŠãã‚‰ã `app/ArticleCard.tsx`

`app/components/ArticleList.tsx` ã‚‚ `app/ArticleList.tsx`

ã†ãƒ¼ã‚“

```
Unhandled Runtime Error
Error: Hydration failed because the initial UI does not match what was rendered on the server.

See more info here: https://nextjs.org/docs/messages/react-hydration-error
```

â†‘ãŒ2å›ã¨ã€â†“ãŒ1å›ã€‚

```
Error: There was an error while hydrating this Suspense boundary. Switched to client rendering.
```

ã“ã‚ŒãŒåŸå› ã ã‚ã†ã‹ã€‚

> Common causes with css-in-js libraries:
>
> When using Styled Components / Emotion

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã“ã†ã„ã†ã®ã‚‚å‡ºã¦ã„ã‚‹ï¼š
```
Warning: Expected server HTML to contain a matching <h1> in <div>.
```

## ã‚³ãƒ¡ãƒ³ãƒˆã®å–å¾—

> `revalidate` ã¯ `fetch` ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ¸¡ã™ã ã‘ã§ãªãã€ãƒ«ãƒ¼ãƒˆå˜ä½ã®è¨­å®šã‚‚ã§ãã¾ã™ã€‚ãƒ«ãƒ¼ãƒˆå˜ä½ã§è¨­å®šã™ã‚‹ã«ã¯ `page` ã¾ãŸã¯ `layout` ãƒ•ã‚¡ã‚¤ãƒ«ã§ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚
>
> ```ts
> export const revalidate = 60
> ```

ISRã£ã½ã„ã€‚

`app/pages/articles/[slug].tsx` ã¨ã‚ã‚‹ãŒã€ `app/articles/[slug]/page.tsx`ã€‚
`app/pages/articles/not-found.tsx` ã¨ã‚ã‚‹ãŒã€`app/articles/[slug]/not-found.tsx`

`fallback` ã¨ã¯åˆ¥ã«404ç”»é¢ã‚’å‡ºã›ã‚‹ã€‚
```ts
  if (res.status === 404) {
    // notFound é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã¨ not-fount.tsx ã‚’è¡¨ç¤ºã™ã‚‹
    notFound();
  }

  if (!res.ok) {
    throw new Error("Failed to fetch article");
  }
```

ã“ã®æ™‚ç‚¹ã§ `/articles/hoge.tsx` ã‚’é–‹ãã¨ã€`Article` ã®åå‰ï¼ˆå‹åã¨ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰ãŒé‡è¤‡ã—ã¦ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸã€‚

`app/pages/articles/[slug].tsx` ã¨ã‚ã‚‹ãŒã€ `app/articles/[slug]/page.tsx`ã€‚

```diff
-  return data.comments as Comment[];
+  return data as Comment[];
```

Resolveã•ã‚Œã‚‹å‰ã« `Comments` ãŒãƒ¬ãƒ³ãƒ€ãƒ¼ã•ã‚Œã¦ã—ã¾ã†ã€‚

```
TypeError: Cannot read properties of undefined (reading 'map')
    at Comments (webpack-internal:///(sc_server)/./app/articles/[slug]/page.tsx:93:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
TypeError: Cannot read properties of undefined (reading 'map')
    at Comments (webpack-internal:///(sc_server)/./app/articles/[slug]/page.tsx:93:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5) {
  digest: '1623454996'
}
```

è§£æ±ºã—ãªã„ã®ã§ä¿ç•™ã€‚

è½ã¡ã‚‹â€¦â€¦

```
TypeError: fetch failed
    at Object.fetch (node:internal/deps/undici/undici:11404:11)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async getArticle (C:\path\to\nextjs-app-dir-example\.next\server\app\articles\[slug]\page.js:427:17)
    at async ArticleDetail (C:\path\to\nextjs-app-dir-example\.next\server\app\articles\[slug]\page.js:455:21) {
  cause: Error: connect ECONNREFUSED ::1:3000
      at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1494:16)
      at TCPConnectWrap.callbackTrampoline (node:internal/async_hooks:130:17) {
    errno: -4078,
    code: 'ECONNREFUSED',
    syscall: 'connect',
    address: '::1',
    port: 3000
  }
}
[Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.] {
  digest: '2973016215'
}
node:internal/deps/undici/undici:11404
    Error.captureStackTrace(err, this);
          ^

TypeError: fetch failed
    at Object.fetch (node:internal/deps/undici/undici:11404:11)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async getComments (C:\path\to\nextjs-app-dir-example\.next\server\app\articles\[slug]\page.js:443:17) {
  cause: Error: connect ECONNREFUSED ::1:3000
      at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1494:16)
      at TCPConnectWrap.callbackTrampoline (node:internal/async_hooks:130:17) {
    errno: -4078,
    code: 'ECONNREFUSED',
    syscall: 'connect',
    address: '::1',
    port: 3000
  }
}

Node.js v18.14.1
error Command failed with exit code 1.
```

`package.json` ã‚’ `complete` ãƒ–ãƒ©ãƒ³ãƒã«æƒãˆã¦ã¿ã‚‹â†’ã ã‚
https://github.com/azukiazusa1/nextjs-app-dir-example/blob/complete/package.json

`complete`ãƒ–ãƒ©ãƒ³ãƒã‚’å‹•ã‹ã—ã¦ã¿ã‚‹â†’OK

ãªã‚‰Nodeã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ãªãã¦ã‚³ãƒ¼ãƒ‰ã®å•é¡Œã ã€‚

---

ã‚ã»ã ã£ãŸâ€¦â€¦â€¦â€¦ã€‚ã‚¿ã‚¤ãƒã ã£ãŸã€‚ï¼`commentPromise`ã¨`commetsPromise`ãŒæ··åœ¨ã€‚
```tsx
{/* @ts-expect-error ç¾çŠ¶ã¯ jsx ãŒ Promise ã‚’è¿”ã™ã¨ TypeScript ãŒå‹ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã™ã‚‹ãŒã€å°†æ¥çš„ã«ã¯è§£æ±ºã•ã‚Œã‚‹ */}
<Comments commentPromise={commentsPromise} />
```

```tsx
export default async function Comments({
    commentsPromise,
  }: {
    commentsPromise: Promise<Comment[]>;
  }) {
```
ã‚¨ãƒ©ãƒ¼æŠ‘åˆ¶ã—ã¦ã„ãŸã›ã„ã§æœªå®šç¾©ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã«æ°—ä»˜ã‹ãšâ€¦â€¦ã€‚
ã¨ã„ã†ã‹æœªå®šç¾©ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã“ã¨è‡ªä½“ã¯JSçš„ã«ã¯å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã®ã‹ã€‚
ãƒ“ãƒ«ãƒ‰ã‚‚é€šã£ã¦ã—ã¾ã†ã®ã§æ°—ä»˜ã‘ãªã‹ã£ãŸã€‚

## metadata

> ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã”ã¨ã« `<head>` ã‚¿ã‚°ã‚’è¨­å®šã™ã‚‹ã«ã¯ã€`page.tsx` ã¾ãŸã¯ `layout.tsx` ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ `metadata` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯ `generateMetadata` é–¢æ•°ã‚’åå‰ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

`generateMetadata` ã®å‹(`GenerateMetadata`)ãŒæ¬²ã—ã„ãŒç„¡ã„ï¼Ÿ`Metadata` å‹ã¯ã‚ã‚‹ã€‚

> `ArticleDetail` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã„ã‚‹ã®ã§ä¸€è¦‹éåŠ¹ç‡ãªã‚ˆã†ã«æ€ãˆã¾ã™ãŒã€Next.js ã«ã‚ˆã‚Š `fetch` ã‚’åˆ©ç”¨ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è‡ªå‹•ã§é‡è¤‡æ’é™¤ã•ã‚Œã‚‹ã®ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚

ã™ã”ã™ãã‚‹ã€‚

> "metadata" is not a valid Next.js entry export value.ts(71002)

https://github.com/vercel/next.js/issues/46431